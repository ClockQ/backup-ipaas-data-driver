name: panel
factory: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
reference: com.pharbers.ipaas.data.driver.api.job.PhBaseJob
actions:
- name: readCpa
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: read
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///workData/Clean/20bfd585-c889-4385-97ec-a8d4c77d71cc

- name: readMissHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: read
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///repository/miss_hosp/5ca069bceeefcc012918ec72

- name: readNotPublishHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: read
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///repository/not_published_hosp/5ca069bceeefcc012918ec72

- name: readFullHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: read
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///repository/full_hosp/5ca069bceeefcc012918ec72/20180629

- name: readSampleHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: read
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///repository/sample_hosp/5ca069bceeefcc012918ec72/mz

- name: missHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: filter
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: readMissHosp
      filter: DATE == 201809
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: filter
      drops: DATE
  - name: union
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.UnionOperator
    args:
      inDFName: drop
      unionDFName: readNotPublishHosp
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: union
      drops: _id
  - name: distinct
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DistinctOperator
    args:
      inDFName: drop
  - name: rename
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: distinct
      oldColName: HOSPITAL_ID
      newColName: MISS_HOSPITAL_ID

- name: primalCpa
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: filter
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: readCpa
      filter: YM == 201809

- name: reducedCpa
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: join
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: primalCpa
      joinDFName: missHosp
      joinExpr: MISS_HOSPITAL_ID == HOSPITAL_ID
      joinType: left
  - name: filter
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: join
      filter: MISS_HOSPITAL_ID IS NULL
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: filter
      drops: MISS_HOSPITAL_ID

- name: cpa
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: filter
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: readFullHosp
      filter: YM == 201809
  - name: join
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: filter
      joinDFName: missHosp
      joinExpr: MISS_HOSPITAL_ID == HOSPITAL_ID
      joinType: inner
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: join
      drops: MISS_HOSPITAL_ID
  - name: union
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.UnionOperator
    args:
      inDFName: drop
      unionDFName: reducedCpa

- name: sampleHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: filter
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: readSampleHosp
      filter: "MARKET == '麻醉市场' AND SAMPLE == 1"
  - name: rename
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: filter
      oldColName: HOSPITAL_ID
      newColName: SAMPLE_HOSPITAL_ID

- name: panelResult
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: join
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: cpa
      joinDFName: sampleHosp
      joinExpr: SAMPLE_HOSPITAL_ID == HOSPITAL_ID
      joinType: inner
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: join
      drops: SAMPLE_HOSPITAL_ID
  - name: concant
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: drop
      newColName: GROUP
    plugin:
      name: concat
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ConcatStrPlugin
      args:
        columns: COMPANY_ID#YM#HOSPITAL_ID#PRODUCT_ID
        dilimiter: "#"
  - name: group
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.GroupOperator
    args:
      inDFName: concant
      groups: GROUP
      aggExprs: sum(UNITS) as UNITS#sum(SALES) as SALES#first(COMPANY_ID) as COMPANY_ID#first(YM) as YM#first(HOSPITAL_ID) as HOSPITAL_ID#first(PRODUCT_ID) as PRODUCT_ID
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: group
      drops: GROUP