name: panel
reference: com.pharbers.ipaas.data.driver.api.job.PhBaseJob
factory: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
actions:
- name: readCpaFile
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: loadCpaFromParquet
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadCsvOperator
    args:
      path: hdfs:///data/nhwa/pha_config_repository1809/Nhwa_201809_CPA_20181126.csv
  - name: hospIdCastInt
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: loadCpaFromParquet
      newColName: HOSP_ID
    plugin:
      name: castInt
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: cast(HOSP_ID as int)
- name: readHospitalFile
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: loadHospitalFile
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///repository/hosp_dis_max
- name: readProductFile
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: loadProductFile
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///repository/prod_etc_dis_max/5ca069bceeefcc012918ec72
  - name: concantMin2
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: loadProductFile
      newColName: min2
    plugin:
      name: concatMin2
      reference: com.pharbers.ipaas.data.driver.plugins.ConcatStrPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      args:
        columns: ETC_PRODUCT_NAME#ETC_DOSAGE_NAME#ETC_PACKAGE_DES#ETC_PACKAGE_NUMBER#ETC_CORP_NAME
        dilimiter: ""
  - name: productSelect
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: concantMin2
      selects: DEV_PRODUCT_ID as PRODUCT_ID#regexp_replace(min2, " ", "") as min2
- name: readPhaFile
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: loadPhaFile
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///repository/pha
- name: readProductMatchFile
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: loadProductMatchFile
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadCsvOperator
    args:
      path: hdfs:///data/nhwa/pha_config_repository1809/Nhwa_ProductMatchTable_20181126.csv
  - name: productMatchSelect
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: loadProductMatchFile
      selects: regexp_replace(MIN_PRODUCT_UNIT, " ", "") as MIN_PRODUCT_UNIT#regexp_replace(MIN_PRODUCT_UNIT_STANDARD, " ", "") as MIN_PRODUCT_UNIT_STANDARD
- name: distinctHosp
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: hospitalSelect
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: readHospitalFile
      selects: HOSPITAL_ID#PHA_HOSP_ID
  - name: distinctByKey
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
    args:
      inDFName: hospitalSelect
      keys: PHA_HOSP_ID
- name: distinctPha
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: phaSelect
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: readPhaFile
      selects: CPA#PHA_ID_NEW
  - name: hospIdCastInt
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: phaSelect
      newColName: CPA
    plugin:
      name: castInt
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: cast(CPA as int)
  - name: DistinctByCpa
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
    args:
      inDFName: hospIdCastInt
      keys: CPA
- name: cpaMatchHosp
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: joinPha
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: readCpaFile
      joinDFName: distinctPha
      joinExpr: HOSP_ID = CPA
      joinType: left
  - name: joinHosp
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: joinPha
      joinDFName: distinctHosp
      joinExpr: PHA_ID_NEW = PHA_HOSP_ID
      joinType: left
  - name: addHospId
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: joinHosp
      newColName: HOSPITAL_ID
    plugin:
      name: fillHospId
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: case when HOSPITAL_ID is not null then HOSPITAL_ID else concat("other", HOSP_ID) end
- name: cpaMatchProduct
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: concantMin1
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: cpaMatchHosp
      newColName: min1
    plugin:
      name: concatMin1
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ConcatStrPlugin
      args:
        columns: PRODUCT_NAME#DOSAGE#PACK_DES#PACK_NUMBER#CORP_NAME
        dilimiter: ""
  - name: regexpReplaceMin1
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: concantMin1
      newColName: min1
    plugin:
      name: regexpReplaceMin1
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: regexp_replace(min1, " ", "")
  - name: joinProductMatch
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: regexpReplaceMin1
      joinDFName: readProductMatchFile
      joinExpr: min1 = MIN_PRODUCT_UNIT
      joinType: left
  - name: joinProduct
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: joinProductMatch
      joinDFName: readProductFile
      joinExpr: MIN_PRODUCT_UNIT_STANDARD = min2
      joinType: left
- name: cleanPanel
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: litCompanyId
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: cpaMatchProduct
      newColName: COMPANY_ID
    plugin:
      name: litCompanyId
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: "'5ca069bceeefcc012918ec72'"
  - name: litSOURCE
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: litCompanyId
      newColName: SOURCE
    plugin:
      name: litSOURCE
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: "'CPA'"
  - name: litProductNameNote
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: litSOURCE
      newColName: PRODUCT_NAME_NOTE
    plugin:
      name: litProductNameNote
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: "''"
  - name: addYM
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: litProductNameNote
      newColName: YM
    plugin:
      name: addYM
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.MergeYMPlugin
      args:
        yearColName: YEAR
        monthColName: MONTH
  - name: SelectKeepCol
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: addYM
      selects: COMPANY_ID#SOURCE#YM#HOSPITAL_ID#PRODUCT_ID#cast(VALUE as double) as SALES#cast(STANDARD_UNIT as double) as UNITS#PRODUCT_NAME_NOTE
#  - name: generateObjectId
#    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
#    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
#    args:
#      inDFName: SelectKeepCol
#      newColName: _id
#    plugin:
#      name: generateObjectId
#      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
#      reference: com.pharbers.ipaas.data.driver.plugin.generateObjectId