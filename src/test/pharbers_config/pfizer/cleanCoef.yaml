name: clean coef
reference: com.pharbers.ipaas.data.driver.api.job.PhBaseJob
factory: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
actions:
  - name: readCoefFile
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    args:
      null: null
    opers:
      - name:
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ReadCsvOperator
        args:
          path: hdfs:///data/pfizer/pha_config_repository1804/Pfizer_CoefForDVP.csv

  - name: readHospitalFile
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read hosp
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        args:
          path: hdfs:///repository/hosp_dis_max
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: df
          filter: PHA_IS_REPEAT == 0
      - name: distinct By PHA_HOSP_ID
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
        args:
          inDFName: df
          keys: PHA_HOSP_ID
      - name: add city
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
          inDFName: df
          newColName: CITY_NAME
        plugin:
          name: fillCity
          factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
          reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
          args:
            exprString: case when CITY_NAME == '福州市' or CITY_NAME == '厦门市' or CITY_NAME == '泉州市' then '福厦泉市' when  CITY_NAME == '中山市' or CITY_NAME == '珠海市' or CITY_NAME == '东莞市' or CITY_NAME == '佛山市' then '珠三角市' else CITY_NAME end
  - name: coefMatchHosp
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: joinPha
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: readCoefFile
          joinDFName: readHospitalFile
          joinExpr: CITY = CITY_NAME
          joinType: left
      - name: select
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
        args:
          inDFName: df
          selects: HOSPITAL_ID#COEF
