name: CNS_R Universe Clean
reference: com.pharbers.ipaas.data.driver.api.job.PhBaseJob
factory: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
actions:
-   name: phaDF
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
        null: null
    opers:
    -   name: readParquet
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        args:
            path: hdfs:///repository/pha

-   name: hospDIS
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
        null: null
    opers:
    -   name: readParquet
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        args:
            path: hdfs:///repository/hosp_dis_max
    -   name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
            inDFName: df
            exprFilter: PHA_IS_REPEAT == 0
    -   name: select
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
        args:
            inDFName: df
            selects: HOSPITAL_ID#PHA_HOSP_ID
    -   name: HOSPITAL_ID
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
        args:
            inDFName: df
            keys: PHA_HOSP_ID

-   name: productDF
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
        null: null
    opers:
    -   name: read universe csv file
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        args:
            path: hdfs:///repository/prod_etc_dis_max/5ca069e2eeefcc012918ec73
    -   name: rename PHA_HOSP_ID to PHA_ID_OLD
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
            inDFName: df
            oldColName: PRODUCT_ID
            newColName: ETC_PRODUCT_ID
    -   name:
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
            inDFName: df
            exprFilter: MARKET == 'CNS_R'
#    -   name:
#        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
#        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
#        args:
#            inDFName: df
#            exprFilter: ETC_DOSAGE_NAME like '%粉针剂%' OR ETC_DOSAGE_NAME like '%注射剂%'

-   name: universeClean
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
        null: null
    opers:
    -   name: read universe csv file
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.api.job.ReadCsvOperator
        args:
            path: hdfs:///data/pfizer/pha_config_repository1804/Pfizer_Universe_CNS_R.csv
            delimiter: ','
    -   name: rename PHA_HOSP_ID to PHA_ID_OLD
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
            inDFName: df
            oldColName: PHA_HOSP_ID
            newColName: PHA_ID_OLD
    -   name:
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
            inDFName: df
            joinDFName: phaDF
            joinExpr: PHA_ID_OLD == PHA_ID
            joinType: left
    -   name:
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
            inDFName: df
            joinDFName: hospDIS
            joinExpr: PHA_ID_NEW == PHA_HOSP_ID
            joinType: left
    -   name: fill HOSPITAL_ID
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
            inDFName: df
            newColName: HOSPITAL_ID
        plugin:
            name: BaseCalcPlugin
            reference: com.pharbers.ipaas.data.driver.plugin.ExprPlugin
            factory: com.pharbers.ipaas.data.driver.factory.PhPluginFactory
            args:
                exprString: case when HOSPITAL_ID IS NULL THEN concat('other', PHA_ID) else HOSPITAL_ID end
    -   name: HOSPITAL_ID
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
        args:
            inDFName: df
            keys: HOSPITAL_ID
            chooseBy: IF_PANEL_TO_USE
            chooseFun: max
    -   name: generateObjectId
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
            inDFName: df
            newColName: _id
        plugin:
            name: add generateObjectId
            reference: com.pharbers.ipaas.data.driver.plugin.GenerateObjectIdPlugin
            factory: com.pharbers.ipaas.data.driver.factory.PhPluginFactory

-   name: universeDF
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    args:
        df: universeClean
    opers:
    -   name: withColumnRenamed
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
            inDFName: df
            oldColName: IF_PANEL_ALL
            newColName: IS_PANEL_HOSP
    -   name:
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
            inDFName: df
            oldColName: IF_PANEL_TO_USE

