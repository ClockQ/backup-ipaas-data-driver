#threeSourceTablePath, hospERDPath, phaERDPath
name: clean three source table for cpa
reference: com.pharbers.ipaas.data.driver.api.job.PhBaseJob
factory: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
actions:
  - name: readThreeSourceTable
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ReadCsvOperator
        args:
          path: *threeSourceTablePath
          delimiter: ','
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: read
          filter: CPA_DIS is null and CPA_ID is not null
      - name: select
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
        args:
          inDFName: filter
          selects: CPA_ID#STANDARD_ID

  - name: readHospitalFile
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        args:
          path: *hospERDPath
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: read
          filter: PHA_IS_REPEAT == 0
      - name: hospitalSelect
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
        args:
          inDFName: filter
          selects: HOSPITAL_ID#PHA_HOSP_ID
      - name: distinct By PHA_HOSP_ID
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
        args:
          inDFName: hospitalSelect
          keys: PHA_HOSP_ID

  - name: readPhaFile
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        args:
          path: *phaERDPath
      - name: phaSelect
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
        args:
          inDFName: read
          selects: CPA#PHA_ID_NEW
      - name: hospIdCastInt
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
          inDFName: phaSelect
          newColName: CPA
        plugin:
          name: castInt
          factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
          reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
          args:
            exprString: cast(CPA as int)
      - name: DistinctByKey
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
        args:
          inDFName: hospIdCastInt
          keys: CPA

  - name: result
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: joinPha
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: readThreeSourceTable
          joinDFName: readPhaFile
          joinExpr: CPA_ID = CPA
          joinType: left
      - name: joinHosp
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: joinPha
          joinDFName: readHospitalFile
          joinExpr: PHA_ID_NEW = PHA_HOSP_ID
          joinType: left
      - name: addHospId
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
          inDFName: joinHosp
          newColName: HOSPITAL_ID
        plugin:
          name: fillHospId
          factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
          reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
          args:
            exprString: case when HOSPITAL_ID is not null then HOSPITAL_ID else concat("other", CPA_ID) end
      - name: select
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
        args:
          inDFName: addHospId
          selects: HOSPITAL_ID#STANDARD_ID