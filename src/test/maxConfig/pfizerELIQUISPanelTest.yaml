args:
  gycxERDPath: &gycxERDPath hdfs:///test/dcs/Clean/gycx/pfizer
  gycxSampleHospERDPath: &gycxSampleHospERDPath hdfs:///test/dcs/Clean/sampleHosp/pfizer/ELIQUIS_gycx
  cpaSampleHospERDPath: &cpaSampleHospERDPath hdfs:///test/dcs/Clean/sampleHosp/pfizer/ELIQUIS_cpa
  cpaERDPath: &cpaERDPath hdfs:///test/dcs/Clean/cpa/pfizer
  fullHospERDPath: &fullHospERDPath hdfs:///test/dcs/Clean/fullHosp/pfizer
  missHospERDPath: &missHospERDPath hdfs:///test/dcs/Clean/missHosp/pfizer

#gycxERDPath, cpaERDPath,missHospERDPath,fullHospERDPath, cpaSampleHospERDPath, gycxSampleHospERDPath
name: panel
reference: com.pharbers.ipaas.data.driver.api.job.PhBaseJob
factory: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
actions:
  - name: readCpa
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read cpa
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        args:
          path: *cpaERDPath
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: read cpa
          filter: YM == 201804

  - name: readMissHosp
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        args:
          path: *missHospERDPath

  - name: readFullHosp
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        args:
          path: *fullHospERDPath
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: read
          filter: YM == 201804

  - name: readCpaSampleHosp
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read Cpa Sample Hosp
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        args:
          path: *cpaSampleHospERDPath
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: read Cpa Sample Hosp
          filter: "SAMPLE == 1"
      - name: rename
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
          inDFName: filter
          oldColName: HOSPITAL_ID
          newColName: SAMPLE_HOSPITAL_ID
      - name: rename market
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
          inDFName: rename
          oldColName: MARKET
          newColName: MARKET_P
      #      - name: drop sampleHosp
      #        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
      #        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
      #        args:
      #          inDFName: df
      #          dropColName: MARKET
      - name: drop sampleHosp
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: rename market
          drops: _id

  - name: readGycxSampleHosp
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: readGycxSampleHosp
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        args:
          path: *gycxSampleHospERDPath
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: readGycxSampleHosp
          filter: "SAMPLE == 1"
      - name: rename
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
          inDFName: filter
          oldColName: HOSPITAL_ID
          newColName: SAMPLE_HOSPITAL_ID
      - name: rename market
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
          inDFName: rename
          oldColName: MARKET
          newColName: MARKET_P
#      - name: drop sampleHosp
#        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
#        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
#        args:
#          inDFName: df
#          dropColName: MARKET
      - name: drop sampleHosp
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: rename market
          drops: _id

  - name: readGycx
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        args:
          path: *gycxERDPath
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: read
          filter: YM == 201804
      - name: join sampleGycxHosp
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: filter
          joinDFName: readGycxSampleHosp
          joinExpr: SAMPLE_HOSPITAL_ID == HOSPITAL_ID and MARKET == MARKET_P
          joinType: inner
      - name: drop
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: join sampleGycxHosp
          drops: SAMPLE_HOSPITAL_ID

  - name: missHosp
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      df: readMissHosp
    opers:
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: readMissHosp
          filter: DATE == 201804
      - name: drop Date
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: filter
          drops: DATE
      - name: drop
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: drop Date
          drops: _id
      - name: distinct
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DistinctOperator
        args:
          inDFName: drop
          null: null
      - name: rename
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
          inDFName: distinct
          oldColName: HOSPITAL_ID
          newColName: MISS_HOSPITAL_ID

  - name: primalCpa
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      df: readCpa
    opers:
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: readCpa
          filter: YM == 201804

  - name: reducedCpa
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      df: primalCpa
    opers:
      - name: join
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: primalCpa
          joinDFName: missHosp
          joinExpr: MISS_HOSPITAL_ID == HOSPITAL_ID
          joinType: left
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: join
          filter: MISS_HOSPITAL_ID IS NULL
      - name: drop
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: filter
          drops: MISS_HOSPITAL_ID

  - name: cpa
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      df: readFullHosp
    opers:
      - name: filter
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
        args:
          inDFName: readFullHosp
          filter: YM == 201804
      - name: join
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: filter
          joinDFName: missHosp
          joinExpr: MISS_HOSPITAL_ID == HOSPITAL_ID
          joinType: inner
      - name: drop
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: join
          drops: MISS_HOSPITAL_ID
      - name: union
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.UnionOperator
        args:
          inDFName: drop
          unionDFName: reducedCpa

  - name: panelERD
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
      df: cpa
    opers:
      - name: join sampleHosp
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: cpa
          joinDFName: readCpaSampleHosp
          joinExpr: SAMPLE_HOSPITAL_ID == HOSPITAL_ID and MARKET == MARKET_P
          joinType: inner
      - name: drop
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: join sampleHosp
          drops: SAMPLE_HOSPITAL_ID
      - name: union gycx
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.UnionOperator
        args:
          inDFName: drop
          unionDFName: readGycx
      - name: concant
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
          inDFName: union gycx
          newColName: GROUP
        plugin:
          name: concat
          reference: com.pharbers.ipaas.data.driver.plugins.ConcatStrPlugin
          factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
          args:
            columns: COMPANY_ID#YM#HOSPITAL_ID#PRODUCT_ID
            dilimiter: "#"
      - name: group panel
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.GroupOperator
        args:
          inDFName: concant
          groups: GROUP
          aggExprs: sum(UNITS) as UNITS#sum(SALES) as SALES#first(COMPANY_ID) as COMPANY_ID#first(YM) as YM#first(HOSPITAL_ID) as HOSPITAL_ID#first(PRODUCT_ID) as PRODUCT_ID
      - name: drop
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: group panel
          drops: GROUP
