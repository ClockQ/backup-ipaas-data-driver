args:
  universePath: &universePath hdfs:///data/pfizer/pha_config_repository1804/Pfizer_Universe_CNS_R.csv
  hospERDPath: &hospERDPath hdfs:///repository/hosp_dis_max
  phaERDPath: &phaERDPath hdfs:///repository/pha

#universePath,hospERDPath,phaERDPath
name: commonMax
reference: com.pharbers.ipaas.data.driver.api.job.PhBaseJob
factory: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
actions:
  -   name: phaDF
      reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
      factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
      opers:
        -   name: readParquet
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
            args:
              path: *phaERDPath

  -   name: hospDIS
      reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
      factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
      opers:
        -   name: readParquet
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
            args:
              path: *hospERDPath
        -   name: filter
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
            args:
              inDFName: readParquet
              filter: PHA_IS_REPEAT == 0
        -   name: select
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
            args:
              inDFName: filter
              selects: HOSPITAL_ID#PHA_HOSP_ID
        -   name: HOSPITAL_ID
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
            args:
              inDFName: select
              keys: PHA_HOSP_ID

  -   name: universeClean
      reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
      factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
      opers:
        -   name: read universe csv file
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.ReadCsvOperator
            args:
              path: *universePath
              delimiter: ','
        -   name: rename PHA_HOSP_ID to PHA_ID_OLD
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
            args:
              inDFName: read universe csv file
              oldColName: PHA_HOSP_ID
              newColName: PHA_ID_OLD
        -   name: Join pha
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
            args:
              inDFName: rename PHA_HOSP_ID to PHA_ID_OLD
              joinDFName: phaDF
              joinExpr: PHA_ID_OLD == PHA_ID
              joinType: left
        -   name: join hosp
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
            args:
              inDFName: Join pha
              joinDFName: hospDIS
              joinExpr: PHA_ID_NEW == PHA_HOSP_ID
              joinType: left
        -   name: fill HOSPITAL_ID
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.addColumn
            args:
              inDFName: join hosp
              newColName: HOSPITAL_ID
            plugin:
              name: BaseCalcPlugin
              reference: com.pharbers.ipaas.data.driver.plugin.BaseCalcPlugin
              factory: com.pharbers.ipaas.data.driver.factory.PhPluginFactory
              args:
                exprString: case when HOSPITAL_ID IS NULL THEN concat('other', PHA_ID) else HOSPITAL_ID end
        -   name: HOSPITAL_ID
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
            args:
              inDFName: fill HOSPITAL_ID
              keys: HOSPITAL_ID
              chooseBy: IF_PANEL_TO_USE
              chooseFun: max
        -   name: generateObjectId
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.addColumn
            args:
              inDFName: HOSPITAL_ID
              newColName: _id
            plugin:
              name: add generateObjectId
              reference: com.pharbers.ipaas.data.driver.plugin.generateObjectId
              factory: com.pharbers.ipaas.data.driver.factory.PhPluginFactory

  -   name: universeDF
      factory: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
      reference: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
      args:
        df: universeClean
      opers:
        -   name: withColumnRenamed
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
            args:
              inDFName: universeClean
              oldColName: IF_PANEL_ALL
              newColName: IS_PANEL_HOSP
        -   name: withColumnRenamed
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
            args:
              inDFName: withColumnRenamed
              oldColName: IF_PANEL_TO_USE
              newColName: NEED_MAX_HOSP
