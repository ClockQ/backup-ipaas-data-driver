name: pfizerDVPMax
reference: com.pharbers.ipaas.data.driver.api.job.PhBaseJob
factory: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
actions:
-   name: phaDF
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
        null: null
    opers:
    -   name: readParquet
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
        args:
            path: hdfs:///repository/pha

-   name: hospDIS
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
        null: null
    opers:
    -   name: readParquet
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
        args:
            path: hdfs:///repository/hosp_dis_max
    -   name: filter
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
        args:
            inDFName: df
            filter: PHA_IS_REPEAT == 0
    -   name: select
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.select
        args:
            inDFName: df
            selects: HOSPITAL_ID#PHA_HOSP_ID
    -   name: HOSPITAL_ID
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.distinctByKey
        args:
            inDFName: df
            keys: PHA_HOSP_ID
-   name: panelDF
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
        null: null
    opers:
    -   name: read panel for DVP
        reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        args:
            path: hdfs:///test/dcs/Clean/panel/pfizer/DVP
    -   name: select panelDF for DVP
        reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        args:
            inDFName: df
            selects: YM#HOSPITAL_ID#PRODUCT_ID#SALES#UNITS

-   name: universeClean
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
        null: null
    opers:
    -   name: read universe csv file
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhReadOperator
        args:
            path: hdfs:///data/pfizer/pha_config_repository1804/Pfizer_Universe_DVP.csv
    -   name: rename PHA_HOSP_ID to PHA_ID_OLD
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.withColumnRenamed
        args:
            inDFName: df
            oldColName: PHA_HOSP_ID
            newColName: PHA_ID_OLD
    -   name:
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
            inDFName: df
            joinDFName: phaDF
            joinExpr: PHA_ID_OLD == PHA_ID
            joinType: left
    -   name:
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
            inDFName: df
            joinDFName: hospDIS
            joinExpr: PHA_ID_NEW == PHA_HOSP_ID
            joinType: left
    -   name: fill HOSPITAL_ID
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.addColumn
        args:
            inDFName: df
            newColName: HOSPITAL_ID
        plugin:
            name: BaseCalcPlugin
            reference: com.pharbers.ipaas.data.driver.plugin.BaseCalcPlugin
            factory: com.pharbers.ipaas.data.driver.factory.PhPluginFactory
            args:
                exprString: case when HOSPITAL_ID IS NULL THEN concat('other', PHA_ID) else HOSPITAL_ID end
    -   name: HOSPITAL_ID
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.distinctByKey
        args:
            inDFName: df
            keys: HOSPITAL_ID
            chooseBy: IF_PANEL_TO_USE
            chooseFun: max
    -   name: generateObjectId
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.addColumn
        args:
            inDFName: df
            newColName: _id
        plugin:
            name: add generateObjectId
            reference: com.pharbers.ipaas.data.driver.plugin.generateObjectId
            factory: com.pharbers.ipaas.data.driver.factory.PhPluginFactory

-   name: universeDF
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
        df: universeClean
    opers:
    -   name: rename
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
            inDFName: df
            oldColName: PREFECTURE
            newColName: City
    -   name: rename
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
            inDFName: df
            oldColName: HOSPITAL_ID
            newColName: PHA_HOSPITAL_ID
    -   name: select panelDF for DVP
        reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        args:
            inDFName: df
            selects: Province#City#PHA_HOSPITAL_ID#MARKET

-   name: coefDF
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
        null: null
    opers:
    -   name: read coefDF for DVP
        reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        args:
            path: hdfs:///data/pfizer/pha_config_repository1804/Pfizer_CoefForDVP.csv
    -   name: rename
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
            inDFName: df
            oldColName: HOSPITAL_ID
            newColName: COEF_HOSPITAL_ID

-   name: maxResultDF
    reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
    args:
        df: panelDF
    opers:
    -   name: join
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
            inDFName: df
            joinDFName: universeDF
            joinExpr: HOSPITAL_ID == PHA_HOSPITAL_ID
            joinType: inner
    -   name: join
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
            inDFName: df
            joinDFName: coefDF
            joinExpr: PHA_HOSPITAL_ID == COEF_HOSPITAL_ID
            joinType: left
    -   name: add coef
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
            inDFName: df
            newColName: coef
        plugin:
            name: BaseCalcPlugin
            reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
            factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
            args:
                exprString: case when coef IS NULL then 1.204832714 else coef end
    -   name: add SALES
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
            inDFName: df
            newColName: SALES
        plugin:
            name: BaseCalcPlugin
            reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
            factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
            args:
                exprString: case when SALES == 0.0 or UNITS == 0.0 then 0.0 else SALES end
    -   name: add UNITS
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
            inDFName: df
            newColName: UNITS
        plugin:
            name: BaseCalcPlugin
            reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
            factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
            args:
                exprString: case when SALES == 0.0 or UNITS == 0.0 then 0.0 else UNITS end
    -   name: add f_sales
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
            inDFName: df
            newColName: f_sales
        plugin:
            name: BaseCalcPlugin
            reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
            factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
            args:
                exprString: SALES * coef
    -   name: add f_units
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
            inDFName: df
            newColName: f_units
        plugin:
            name: BaseCalcPlugin
            reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
            factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
            args:
                exprString: UNITS * coef
    -   name: concant
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
            inDFName: df
            newColName: GROUP
        plugin:
            name: concat
            reference: com.pharbers.ipaas.data.driver.plugins.ConcatStrPlugin
            factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
            args:
                columns: YM,HOSPITAL_ID,PRODUCT_ID,coef,MARKET
                dilimiter: "#"
    -   name: group
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.GroupOperator
        args:
            inDFName: df
            groupCol: GROUP
            agg: sum(Sales) as Sales,sum(Units) as Units,sum(f_sales) as f_sales,sum(f_units) as f_units, first(YM) as YM, first(coef) as coef, first(MARKET) as MARKET, first(HOSPITAL_ID) as HOSPITAL_ID, first(PRODUCT_ID) as PRODUCT_ID
    -   name: drop
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
            inDFName: df
            dropColName: GROUP
    -   name: add column Panel_ID
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
            inDFName: df
            newColName: Panel_ID
        plugin:
            name: BaseCalcPlugin
            reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
            factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
            args:
                exprString: 'null'
    -   name: add column Factor
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
        args:
            inDFName: df
            newColName: Factor
        plugin:
            name: BaseCalcPlugin
            reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
            factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
            args:
                exprString: 'null'
    -   name: rename YM to Date
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
        args:
            inDFName: df
            oldColName: YM
            newColName: DATE
    -   name: select panelDF for DVP Max result
        reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
        factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
        args:
            inDFName: df
            selects: Date#HOSPITAL_ID#PRODUCT_ID#f_units#f_sales
