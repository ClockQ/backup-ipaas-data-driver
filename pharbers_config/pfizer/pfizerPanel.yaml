name: panel
reference: com.pharbers.ipaas.data.driver.job.PhBaseJob
factory: com.pharbers.ipaas.data.driver.factory.PhJobFactory
actions:
  - name: readCpa
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read
        reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        args:
          path: hdfs:///test/dcs/Clean/cpa/inf
      - name: filter
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
        args:
          inDFName: df
          filter: YM == 201804 AND MARKET == 'INF'
  #      - name: drop
  #        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
  #        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
  #        args:
  #          inDFName: df
  #          dropColName: MARKET

  #  - name: readProdErd
  #    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
  #    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
  #    args:
  #      null: null
  #    opers:
  #      - name: read
  #        reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
  #        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
  #        args:
  #          #            ProdErd path
  #          path: hdfs:///repository/prod_etc_dis_max/5ca069e2eeefcc012918ec73
  #      - name: select
  #        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
  #        reference: com.pharbers.ipaas.data.driver.operators.select
  #        args:
  #          inDFName: df
  #          selects: MARKET#DEV_PRODUCT_ID
  #      - name: filter
  #        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
  #        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
  #        args:
  #          inDFName: df
  #          filter: MARKET == 'INF'


  - name: readMissHosp
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read
        reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        args:
          path: hdfs:///test/dcs/Clean/missHosp/pfizer


  - name: readFullHosp
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read
        reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        args:
          path: hdfs:///test/dcs/Clean/fullHosp/inf
      - name: filter
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
        args:
          inDFName: df
          filter: YM == 201804 AND MARKET == 'INF'


  - name: readCpaSampleHosp
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read Cpa Sample Hosp
        reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        args:
          path: hdfs:///test/dcs/Clean/sampleHosp/pfizer/cpa
      - name: filter
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
        args:
          inDFName: df
          filter: "MARKET == 'INF' AND SAMPLE == 1"
      - name: rename
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.withColumnRenamed
        args:
          inDFName: df
          oldColName: HOSPITAL_ID
          newColName: SAMPLE_HOSPITAL_ID
      - name: drop sampleHosp
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: MARKET
      - name: drop sampleHosp
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: _id

  - name: readGycxSampleHosp
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: readGycxSampleHosp
        reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        args:
          path: hdfs:///test/dcs/Clean/sampleHosp/pfizer/gycx
      - name: filter
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
        args:
          inDFName: df
          filter: "MARKET == 'INF' AND SAMPLE == 1"
      - name: rename
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.withColumnRenamed
        args:
          inDFName: df
          oldColName: HOSPITAL_ID
          newColName: SAMPLE_HOSPITAL_ID
      - name: drop sampleHosp
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: MARKET
      - name: drop sampleHosp
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: _id

  - name: readGycx
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      null: null
    opers:
      - name: read
        reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        args:
          path: hdfs:///test/dcs/Clean/gycx/inf
      - name: filter
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
        args:
          inDFName: df
          filter: YM == 201804 AND MARKET == 'INF'
      - name: join sampleGycxHosp
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: df
          joinDFName: readGycxSampleHosp
          joinExpr: SAMPLE_HOSPITAL_ID == HOSPITAL_ID
          joinType: inner
      - name: drop
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: SAMPLE_HOSPITAL_ID
  #      - name: drop
  #        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
  #        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
  #        args:
  #          inDFName: df
  #          dropColName: MARKET

  - name: missHosp
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      df: readMissHosp
    opers:
      - name: filter
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
        args:
          inDFName: df
          filter: DATE == 201804
      - name: drop
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: DATE
      #            - name: union
      #              factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
      #              reference: com.pharbers.ipaas.data.driver.operators.unionOperator
      #              args:
      #                inDFName: df
      #                unionDFName: readNotPublishHosp
      - name: drop
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: _id
      - name: distinct
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DistinctOperator
        args:
          inDFName: df
          null: null
      - name: rename
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.withColumnRenamed
        args:
          inDFName: df
          oldColName: HOSPITAL_ID
          newColName: MISS_HOSPITAL_ID

  - name: primalCpa
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      df: readCpa
    opers:
      - name: filter
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
        args:
          inDFName: df
          filter: YM == 201804

  - name: reducedCpa
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      df: primalCpa
    opers:
      - name: join
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: df
          joinDFName: missHosp
          joinExpr: MISS_HOSPITAL_ID == HOSPITAL_ID
          joinType: left
      - name: filter
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
        args:
          inDFName: df
          filter: MISS_HOSPITAL_ID IS NULL
      - name: drop
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: MISS_HOSPITAL_ID

  - name: cpa
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      df: readFullHosp
    opers:
      - name: filter
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
        args:
          inDFName: df
          filter: YM == 201804
      - name: join
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: df
          joinDFName: missHosp
          joinExpr: MISS_HOSPITAL_ID == HOSPITAL_ID
          joinType: inner
      - name: drop
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: MISS_HOSPITAL_ID
      - name: union
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.unionOperator
        args:
          inDFName: df
          unionDFName: reducedCpa
      #      - name: join readProdErd
      #        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
      #        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
      #        args:
      #          inDFName: df
      #          joinDFName: readProdErd
      #          joinExpr: DEV_PRODUCT_ID == PRODUCT_ID
      #          joinType: inner
  #      - name: drop
  #        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
  #        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
  #        args:
  #          inDFName: df
  #          dropColName: DEV_PRODUCT_ID

  #  - name: sampleHosp
  #    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
  #    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
  #    args:
  #      df: readSampleHosp
  #    opers:
  #      - name: filter
  #        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
  #        reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
  #        args:
  #          inDFName: df
  #          filter: "MARKET == 'INF' AND SAMPLE == 1"
  #      - name: rename
  #        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
  #        reference: com.pharbers.ipaas.data.driver.operators.withColumnRenamed
  #        args:
  #          inDFName: df
  #          oldColName: HOSPITAL_ID
  #          newColName: SAMPLE_HOSPITAL_ID
  #      - name: drop sampleHosp
  #        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
  #        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
  #        args:
  #          inDFName: df
  #          dropColName: MARKET

  - name: panelERD
    reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
    factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
    args:
      df: cpa
    opers:
      - name: join sampleHosp
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
        args:
          inDFName: df
          joinDFName: readCpaSampleHosp
          joinExpr: SAMPLE_HOSPITAL_ID == HOSPITAL_ID
          joinType: inner
      - name: drop
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: SAMPLE_HOSPITAL_ID
      - name: union gycx
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.unionOperator
        args:
          inDFName: df
          unionDFName: readGycx
      - name: concant
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.addColumn
        args:
          inDFName: df
          newColName: GROUP
        plugin:
          name: concat
          reference: com.pharbers.ipaas.data.driver.plugin.ConcatStrPlugin
          factory: com.pharbers.ipaas.data.driver.factory.PhPluginFactory
          args:
            columns: COMPANY_ID,YM,HOSPITAL_ID,PRODUCT_ID
            dilimiter: "#"
      - name: group panel
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.groupOperator
        args:
          inDFName: df
          groupCol: GROUP
          agg: sum(UNITS) as UNITS,sum(SALES) as SALES,first(COMPANY_ID) as COMPANY_ID,first(YM) as YM,first(HOSPITAL_ID) as HOSPITAL_ID,first(PRODUCT_ID) as PRODUCT_ID,
      - name: drop
        factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
        reference: com.pharbers.ipaas.data.driver.operators.DropOperator
        args:
          inDFName: df
          dropColName: GROUP