name: commonMax
reference: com.pharbers.ipaas.data.driver.api.job.PhBaseJob
factory: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
actions:
  -   name: phaDF
      reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
      factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
      args:
        null: null
      opers:
        -   name: readParquet
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
            args:
              path: hdfs:///repository/pha

  -   name: hospDIS
      reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
      factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
      args:
        null: null
      opers:
        -   name: readParquet
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
            args:
              path: hdfs:///repository/hosp_dis_max
        -   name: filter
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
            args:
              inDFName: df
              filter: PHA_IS_REPEAT == 0
        -   name: select
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
            args:
              inDFName: df
              selects: HOSPITAL_ID#PHA_HOSP_ID
        -   name: HOSPITAL_ID
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
            args:
              inDFName: df
              keys: PHA_HOSP_ID
  -   name: panelData
      reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
      factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
      args:
        null: null
      opers:
        -   name: readParquet
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.ReadCsvOperator
            args:
              path: hdfs:///data/servier/201806_all_correct/IHD_Panel 201806.csv
        -   name: rename Date to YM
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
            args:
              inDFName: df
              oldColName: Date
              newColName: YM
        -   name: rename HOSP_ID to HOSPITAL_ID
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
            args:
              inDFName: df
              oldColName: HOSP_ID
              newColName: PHA_ID_OLD
        -   name:
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
            args:
              inDFName: df
              joinDFName: phaDF
              joinExpr: PHA_ID_OLD == PHA_ID
              joinType: left
        -   name:
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
            args:
              inDFName: df
              joinDFName: hospDIS
              joinExpr: PHA_ID_NEW == PHA_HOSP_ID
              joinType: left
        -   name: fill HOSPITAL_ID
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
            args:
              inDFName: df
              newColName: HOSPITAL_ID
            plugin:
              name: BaseCalcPlugin
              reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
              factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
              args:
                exprString: case when HOSPITAL_ID IS NULL THEN concat('other', PHA_ID) else HOSPITAL_ID end
        -   name: rename Units to UNITS
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
            args:
              inDFName: df
              oldColName: Units
              newColName: UNITS
        -   name: rename Strength to PRODUCT_ID
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
            args:
              inDFName: df
              oldColName: Strength
              newColName: PRODUCT_ID
        -   name: rename Sales to SALES
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
            args:
              inDFName: df
              oldColName: Sales
              newColName: SALES
        -   name: select
            factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
            args:
              inDFName: df
              selects: YM#HOSPITAL_ID#PRODUCT_ID#SALES#UNITS