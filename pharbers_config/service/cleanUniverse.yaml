name: un
reference: com.pharbers.ipaas.data.driver.job.PhBaseJob
factory: com.pharbers.ipaas.data.driver.factory.PhJobFactory
actions:
  -   name: phaDF
      reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
      factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
      args:
        null: null
      opers:
        -   name: readParquet
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
            args:
              path: hdfs:///repository/pha

  -   name: hospDIS
      reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
      factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
      args:
        null: null
      opers:
        -   name: readParquet
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.job.PhReadParquetOperator
            args:
              path: hdfs:///repository/hosp_dis_max
        -   name: filter
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.job.PhFilterOperator
            args:
              inDFName: df
              filter: PHA_IS_REPEAT == 0
        -   name: select
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.select
            args:
              inDFName: df
              selects: HOSPITAL_ID#PHA_HOSP_ID
        -   name: HOSPITAL_ID
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.distinctByKey
            args:
              inDFName: df
              keys: PHA_HOSP_ID
  -   name: universeClean
      reference: com.pharbers.ipaas.data.driver.job.PhBaseAction
      factory: com.pharbers.ipaas.data.driver.factory.PhActionFactory
      args:
        null: null
      opers:
        -   name: read universe csv file
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.job.PhReadOperator
            args:
              path: hdfs:///data/servier/201806_all_correct/Servier_Universe_IHD_20181119.csv
        -   name: rename PHA_HOSP_ID to PHA_ID_OLD
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.withColumnRenamed
            args:
              inDFName: df
              oldColName: PHA_HOSP_ID
              newColName: PHA_ID_OLD
        -   name:
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
            args:
              inDFName: df
              joinDFName: phaDF
              joinExpr: PHA_ID_OLD == PHA_ID
              joinType: left
        -   name:
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
            args:
              inDFName: df
              joinDFName: hospDIS
              joinExpr: PHA_ID_NEW == PHA_HOSP_ID
              joinType: left
        -   name: fill HOSPITAL_ID
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.addColumn
            args:
              inDFName: df
              newColName: HOSPITAL_ID
            plugin:
              name: BaseCalcPlugin
              reference: com.pharbers.ipaas.data.driver.plugin.BaseCalcPlugin
              factory: com.pharbers.ipaas.data.driver.factory.PhPluginFactory
              args:
                exprString: case when HOSPITAL_ID IS NULL THEN concat('other', PHA_ID) else HOSPITAL_ID end
        -   name: HOSPITAL_ID
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.distinctByKey
            args:
              inDFName: df
              keys: HOSPITAL_ID
              chooseBy: IF_PANEL_TO_USE
              chooseFun: max
        -   name: generateObjectId
            factory: com.pharbers.ipaas.data.driver.factory.PhOperatorFactory
            reference: com.pharbers.ipaas.data.driver.operators.addColumn
            args:
              inDFName: df
              newColName: _id
            plugin:
              name: add generateObjectId
              reference: com.pharbers.ipaas.data.driver.plugin.generateObjectId
              factory: com.pharbers.ipaas.data.driver.factory.PhPluginFactory